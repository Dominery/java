# 并发编程



### 挑战

并发编程的目的是为了让程序运行得更快，但是，并不是启动更多的线程就能让程序最大限度地并发执行。在进行并发编程时，如果希望通过多线程执行任务让程序运行得更快，会面临非常多的挑战。

#### 上下文切换

CPU通过给每个线程分配CPU时间片来实现单核处理器对多线程的支持功能，利用时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。

CPU在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。任务从保存到再加载的过程就是一次上下文切换。这种保存状态再加载的方式会影响程序效率。

> 时间片是CPU分配给各个线程的时间，因为时间片非常短，所以CPU通过不停地切换线程执行，让我们感觉多个线程是同时执行的，时间片一般是几十毫秒（ms）。

**减少上下文切换的方式**

减少上下文切换的方法有无锁并发编程、CAS算法、使用最少线程和使用协程。

> 协程：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。

#### 死锁

锁是线程同步的工具，但使用不当就会造成死锁的问题。

**避免死锁的方式**

1. 避免一个线程同时获取多个锁。
2. 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源。
3. 尝试使用定时锁，使用lock.tryLock（timeout）来替代使用内部锁机制。
4. 对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况。

#### 资源限制

资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。

如果将某段串行的代码并发执行，因为受限于资源，仍然在串行执行，这时候程序不仅不会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。

> 硬件资源限制有带宽的上传/下载速度、硬盘读写速度和CPU的处理速度。软件资源限制有数据库的连接数和socket连接数等。

**解决资源限制方式**

* 硬件资源限制

  使用集群并行执行程序。既然单机的资源有限制，那么就让程序在多机上运行。

* 软件资源限制

  使用资源池将资源复用。